# 上下文摘要系统优化 - 实施计划

## 概述
- **目标**: 让第二大脑通过每次对话的知识沉淀越来越聪明
- **核心**: 通过系统提示词让 LLM 自动生成高质量结构化摘要
- **产出**: 存入向量库，供未来精准检索

---

## 任务清单

### Phase 1: 设计 (已完成后无需修改)
- [x] 设计摘要字段
- [x] 确定 JSON 结构
- [x] 设计提示词模板

### Phase 2: 实施
- [ ] 2.1 修改 auto_summary.py - 更新摘要解析器
- [ ] 2.2 更新系统提示词模板 - 添加摘要生成规则
- [ ] 2.3 修改向量库存储 - 支持新字段
- [ ] 2.4 添加测试用例 - 验证摘要质量

### Phase 3: 验证
- [ ] 3.1 端到端测试 - 验证完整流程
- [ ] 3.2 检索测试 - 验证精准度
- [ ] 3.3 性能测试 - 验证无性能下降

---

## 详细任务

### 2.1 修改 auto_summary.py

**文件**: `skills/deepsea-nexus/auto_summary.py`

**改动点**:
1. 更新 `SummaryParser` 支持新 JSON 字段
2. 新增 `StructuredSummary` 数据类
3. 更新 `HybridStorage` 支持新格式

**新 JSON 格式**:
```json
{
  "本次核心产出": "一句话概括",
  "技术要点": ["要点1", "要点2"],
  "代码模式": "可复用代码",
  "决策上下文": "为什么选择这个方案",
  "避坑记录": "应避免的错误",
  "适用场景": "适用的场景描述",
  "搜索关键词": ["标签1", "标签2"],
  "项目关联": "项目名（可选）",
  "置信度": "high/medium/low"
}
```

**验收标准**:
- ✅ 能解析新格式
- ✅ 向后兼容旧格式
- ✅ 摘要质量提升

---

### 2.2 更新系统提示词模板

**文件**: `skills/deepsea-nexus/docs/` 或 OpenClaw 主配置

**新增提示词**:
```markdown
## 🧠 知识沉淀（每次回复必须）

回复前，请用 JSON 格式总结本次对话要点：

```json
{
  "本次核心产出": "一句话说明解决了什么问题",
  "技术要点": ["关键点1", "关键点2"],
  "代码模式": "提取的可复用代码片段（如果有）",
  "决策上下文": "为什么选择这个方案",
  "避坑记录": "应避免的错误/弯路",
  "适用场景": "这个方案适用的场景",
  "搜索关键词": ["标签1", "标签2"],
  "项目关联": "所属项目（可选）",
  "置信度": "high/medium/low"
}
```

**要求**:
- 每个字段都要思考后填写
- 避免泛泛而谈
- 重点突出"未来能用到"的信息
```

**验收标准**:
- ✅ LLM 能理解并生成
- ✅ 不会过度影响回复质量
- ✅ 生成的摘要有长期价值

---

### 2.3 修改向量库存储

**文件**: `skills/deepsea-nexus/nexus_core.py`

**改动点**:
1. 更新 `nexus_add` 支持新字段
2. 更新检索逻辑支持多字段
3. 确保关键词能被语义检索

**验收标准**:
- ✅ 新字段正确存入向量库
- ✅ 检索时能命中关键词
- ✅ 原有功能不受影响

---

### 2.4 添加测试用例

**文件**: `skills/deepsea-nexus/tests/test_summary.py`

**测试场景**:
1. 解析新 JSON 格式
2. 向后兼容旧格式
3. 摘要质量评估
4. 向量库存储验证

---

## 验收标准

### 功能验收
- [ ] 新摘要格式被正确解析
- [ ] 向后兼容旧摘要
- [ ] 向量库存储成功
- [ ] 检索能命中关键词

### 质量验收
- [ ] 摘要有长期复用价值
- [ ] 避免"正确的废话"
- [ ] 知识沉淀模式清晰

### 性能验收
- [ ] 对话延迟无明显增加
- [ ] 向量库查询速度不变
- [ ] 存储大小合理

---

## 风险与回滚

### 风险
1. **LLM 拒绝生成** → 回退到简单摘要
2. **字段不完整** → 设为可选，必填核心字段
3. **检索不精准** → 优化关键词提取

### 回滚计划
- 保留旧代码在 `compat.py`
- 一键切换回旧模式

---

## 时间估算

| 任务 | 预估时间 |
|------|----------|
| 2.1 修改 auto_summary.py | 30 分钟 |
| 2.2 更新提示词模板 | 15 分钟 |
| 2.3 修改向量库存储 | 30 分钟 |
| 2.4 添加测试用例 | 20 分钟 |
| **总计** | **~1.5 小时** |

---

*Plan Version: 1.0*  
*Created: 2026-02-13*  
*Owner: AI Assistant*